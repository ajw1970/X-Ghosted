= Let Me Describe How I Expect This Script to Work

Date: March 15, 2025  
Author: ajw1970  
Status: Tests Passing (Commit abc12345)

This document outlines the expected behavior of the `X-Ghosted` Tampermonkey userscript, designed to assist with identifying and managing posts on `x.com`. The script has evolved from `pre-release/0.6.0`, addressing server overload with a conservative, testable approach.

== Scope
- Operates only on `x.com`:

 // @match        https://x.com/*


== Post Identification and Checking
- **Goal**: Identify posts needing attention (tweets/replies).
- **Container**: Parent of `div[data-testid="cellInnerDiv"]` with at least one `<article>` under a `cellInnerDiv`.
- Retries every 30s if not found, no fallbacks.
- Cached until URL changes (`popstate`).
- **Special Handling**: `https://x.com/*/with_replies*` sets `state.isWithReplies`.
- **Process**:
1. Posts are `<article>` elements in the container.
2. Checked with utilities from `src/utils/`:
   - `articleContainsSystemNotice`: `true` if `textContent` includes "this tweet is unavailable" (`bad`).
   - `articleLinksToTargetCommunities`: `true` if links include `t.co` (`bad`).
   - `findReplyingToWithDepth` (on `/with_replies`): Depth < 10 marks `potential`.
3. Tracked in `state.processedArticles` (Map) by URL: `{ status, checked, element, text, links }`.
4. Highlighted: red (`bad`), yellow (`potential`), green (`good`) (pending implementation).
- **Context Menu**: On `/with_replies`, `potential` posts get "ðŸ‘€" (throttled, pending).

== Post Collapsing
- **Goal**: Hide system notices to focus on checkable posts and trigger content loading.
- **Scope**: All `div[data-testid="cellInnerDiv"]`, collapsing only system notice articles.
- **Behavior**:
- 1 collapse every 30s (throttled).
- `style.display = 'none'` on `cellInnerDiv`.
- Tracked in `state.collapsedElements` (Set) by `dataset.testid + textContent snippet`.
- **Conservatism**: Single collapse per cycle mimics slow scrolling, reducing server load.

== UI Panel
- **Pending**: List `bad`/`potential` posts with color icons and URLs, matching Xâ€™s theme.

== Theme Detection
- **Function**: `detectTheme` checks `data-theme`, `lights-out`, `r-1tl8opc`, defaults to `light`. Fully tested.

== CSV Data Handling
- **Pending**: URL-aware load/save/clear in `localStorage`.

== Dynamic Updates
- **Mechanism**: `MutationObserver` on container or `document.body`, triggers `identifyPosts` and `collapsePosts` (pending).

== Testing
- **Setup**: CommonJS, Jest, JSDOM with mock DOM due to rendering limitations.
- **Utilities**: Real implementations from `src/utils/` replace previous mocks.
- **Tests (10)**: All pass at commit `abc12345`:
- `updateState`, `findPostContainer`, `identifyPosts`, `processArticle`, `collapsePosts`, `getThemeMode` (4 variants).
- **Path Handling**: Uses `path.resolve(__dirname, '../samples/ajweltytest-with-replies.html')` for robustness, though mock DOM overrides file loading.
- **Note**: Mock DOM includes `good`, `bad`, and `potential` posts for full coverage.