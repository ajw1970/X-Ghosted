= Grok Step 1: Master Prompt
:revision-date: March 28, 2025

== Core Principles for Interaction
1. *Blocks First, Full Files When Asked or Needed*: Provide clean, self-contained, copy-paste-ready blocks (e.g., a function, test, or logical section) for isolated changes like "fix this function" or "update this test." Only give the full file if I explicitly say "whole file" or "full src/xGhosted.js," or if the change spans multiple, scattered parts requiring full context (e.g., interdependent functions). If a file is large and risks stalling, default to the smallest complete blocks that work, with clear replacement instructions—never force me to do line-by-line surgery.
2. *Focus First, Ripple Smart*: Stick to what I ask—full files or blocks, no snippets unless I say so.
3. *Nail It, Then Offer More*: Solve my request exactly, then suggest extras only if they fit tight.
4. *No Dance Around*: Straight answers, no fluff—skip the "hope this helps" chatter.
5. *No Micro-Edits*: When updating, provide complete block replacements or full files, not line tweaks. If the change affects 80% or more of the file, give the entire file as a single, copy-paste-ready block. Always include enough context to avoid partial edits or snippets—never use "remaining code" placeholders.
6. *Context Is King*: Use my latest files—track state across messages, no backtracking unless I reset.
7. *Test It First or Move On*: Verify code works or flag it untested—don’t stall on hypotheticals.
8. *Final Files When Asked*: On “Wrap it up,” update the starting context files (`_grok-step1-master-prompt.txt.adoc` and `_grok-context.txt.adoc`) to reflect the latest project state.
9. *No Overreach*: Don’t edit my words or guess beyond my input—stick to what’s given.
10. *Clean Code Blocks*: Don’t add comments like "// In src/xGhosted.js" inside code blocks—state file locations before the block for easy copy-pasting.
11. *No Filename Headers in Code Blocks*: When providing code for copy-pasting, do not prepend filename headers (e.g., "// src/dom/createPanel.js") before the code block. State file locations or context separately before the code if needed, ensuring the code itself is clean and ready for immediate use.
12. *Clarify Change Scope*: Before each code block, clearly describe what’s changed (e.g., “Replaced X function”), where it goes (e.g., “Swap this for the old `highlightPosts`”), and what remains unchanged to avoid ambiguity. Keep all explanations outside the code block, ensuring it’s clean and ready for direct copy-pasting without line-by-line review.

== Project Context
The 0.6.1 release of `xGhosted.js` is a modular, tested userscript, fully leveraging a DOM-driven approach. Posts container is tagged with `data-xGhosted="posts-container"` (scoped to `tabindex="0"`, logs `aria-label`), posts are tagged with `data-xGhosted="postquality.<quality>"` and `data-xGhosted-id="link"`, and CSS classes (`xGhosted-good`, `xGhosted-problem`, etc.) handle highlighting, replacing inline styles. If the container isn’t found, it fails with a user message—no fallback to `main` or `body`. `checkPostInNewTab` analyzes threads (2+ posts) via a throttled Promise, with `highlightPosts` updating DOM and state. MutationObserver watches the tagged container’s children with a 5s timeout for refreshes—DOM-settling checks remain tabled. Esbuild is retained as the build tool—fast and reliable. Tests total 74 across 17 suites, all passing after fixing a rate limit test timeout in `xGhosted.test.js` using `async/await` and proper timer advancement. Manual testing for 50+ posts on `/with_replies` is implemented and awaiting verification. Persistence via `GM_setValue`/`GM_getValue` and CSV export/import persist, with prior fixes (Show/Hide, PROBLEM highlighting) in place.

== Revision History
- March 23, 2025: Updated for 0.6.1—18 tests pass in `xGhosted.test.js`. Persistence via `GM_setValue`/`GM_getValue` added.
- March 24, 2025: Step 5 completed—userscript wrapper with safety optimizations.
- March 25, 2025: Test suite at 24/24 passing in `src/xGhosted.test.js` after fixing timing initialization and `saveState` test. Timing values moved to constructor config, esbuild adopted.
- March 26, 2025: Fixed `build-xGhosted.js` to remove stray ESM `export` statements, ensuring Tampermonkey compatibility. Enforced 1000-article cap in `xGhosted.js`. Fixed "Hide" functionality with proper sizing.
- March 27, 2025: Updated revision date for current review.
- March 28, 2025: Removed `applyHighlight`, refined `checkPostInNewTab` to thread analysis with Promise, updated `highlightPosts` to use throttled check and DOM classes.
- March 28, 2025: Resolved rate limit test failure in `xGhosted.test.js` using `async/await` and proper timer management.