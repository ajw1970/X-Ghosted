= Grok Step 3: Working Description
:revision-date: March 25, 2025

== Current State
- *UI*: Highlights PROBLEM (red), POTENTIAL_PROBLEM (yellow) posts with eye icons, GOOD (none), UNDEFINED (none). Panel (resizable, draggable) lists flagged posts with Copy, Export CSV (5s throttled), Import CSV, Clear, and Manual Check buttons. Theme switching polished with tooltips.
- *Core*: Detects post quality via `identifyPost.js` using DOM only, persists state (capped at 1000 articles) with `GM_setValue`/`GM_getValue`. Manual mode default minimizes server activity.
- *Tests*: `src/xGhosted.test.js`—24 tests pass, covering core functionality. Attempted 28 tests total, but CSV export/import/clear tests moved to `src/xGhosted.csv.test.js` fail due to ESM mocking issues with `writeToClipboard`. Previously, 27/28 passed, with CSV export test failing due to `navigator.clipboard` mocking issues. Safety features (resource caps, throttling) verified in browser testing.
- *Build*: `build-xGhosted.js` script bundles `xGhosted.js` with dependencies into `xGhosted.user.js`, with method deduplication fixed to keep the last occurrence of methods (`createPanel`, `copyLinks`, `loadState`, `saveState`) in place, ensuring syntactically correct output for Prettier formatting.

== End Goal: Version 0.6.1 Features
- CSV export/import/clear done—export throttled at 5s in production, immediate in tests (functional but untested in Jest ESM).
- Manual Check Mode done—toggles via panel, starts enabled for safety, mocked in tests.
- Configurable logging added—`GM_log` or `console.log` set in constructor.
- UI polish done—panel resizable/draggable, theme detection seamless.
- Userscript wrapper done—built with resource limits (1000 articles, 500ms debounce, 1s observer throttle) and server safety (no requests beyond page load).
- Tab checks for GOOD posts (10s) and 5s-batched collapsing pending (roadmap steps 6+).

== Technical Details
- *Depends On*: `GM_setValue`/`GM_getValue` for persistence, `jest` for testing, JSDOM for DOM mocks.
- *Modules*: `xGhosted.js`, `createPanel.js`, `renderPanel.js`, `updateTheme.js`, utils like `postQuality.js`.
- *Build Script*: `build-xGhosted.js` inlines dependencies, applies resource caps (1000 articles, 500ms debounce), and ensures method deduplication for clean output. Planned transition to Rollup for more reliable bundling stalled until test suite is fully resolved.

== Revision History
- March 23, 2025: Updated for 0.6.1—24 tests pass. CSV export and Manual Check Mode added.
- March 24, 2025: Step 3 done—CSV import/clear added. Step 4 done—UI polished. Step 5 done—userscript wrapper with safety optimizations. Build script fixed for method deduplication and Prettier formatting. Plan to transition to Rollup for bundling established.
- March 25, 2025: Test suite at 24/24 passing in `src/xGhosted.test.js`. CSV tests in `src/xGhosted.csv.test.js` deferred due to ESM mocking issues with `writeToClipboard`. Previously 27/28 passed; fix pending to restore full functionality.