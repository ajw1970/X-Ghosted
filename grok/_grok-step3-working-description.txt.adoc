// File: grok/_grok-step3-working-description.txt.adoc
= Grok Step 3: Detailed Description of X-Ghosted Userscript
:author: ajw1970
:date: March 16, 2025
:revdate: March 23, 2025

== Overview
- *Name*: Highlight Potential Problems
- *Purpose*: Flags X.com posts with cues and a panel for moderation ease.
- *Version*: Targeting 0.6.1, fixing 0.6.0 rate limits (ref 2ecaf8f49).
- *Target*: `https://x.com/*`, runs at `document-idle`.

== Current State
- *Detection* (`src/utils/identifyPost.js`):
  - *PROBLEM*: System notices or community links.
  - *POTENTIAL PROBLEM*: Replies to problems, depth < 10.
  - *GOOD*: Clean on first scan, unhighlighted.
  - *UNDEFINED*: Filler, IDs like `/prev/status/123#fillerN`.
- *UI*: Red/yellow/green/none highlights in `xGhosted.js`; panel (0.6.0) lists PROBLEM/POTENTIAL links, Copy button, theme toggle‚Äîall working with `GM_setValue` persistence. CSV, tab checks pending.
- *Tests*: `identifyPosts.test.js` checks detection (7 redundant skips to cut); `xGhosted.test.js` verifies integration (all passing); `src/dom/` tests solid‚Äî`createPanel.test.js` fixed (expects panel in DOM).

== End Goal: Version 0.6.1
- *Core*: `xGhosted.js` drives `highlight-potential-problems.js`, deterministic IDs set, DOM logic in `src/dom/`.
- *Features*:
  - *Theme Sync*: Matches X.com‚Äôs light/dim/dark via `getThemeMode()`‚Äîdone.
  - *Post ID*: `div[data-testid="cellInnerDiv"] > article:not(article article)`‚Äîdone.
  - *Visuals* (Done): PROBLEM (red), POTENTIAL PROBLEM (yellow, eye), GOOD (green post-check), UNDEFINED (none).
  - *Panel* (Partial): PROBLEM/POTENTIAL links, Copy, theme toggle done with persistence; CSV (5s throttle), toggles to refine.
  - *Checks*: Eye icon (`üëÄ`) on potential; 2s-debounced GOOD tab checks pending.
  - *Collapsing*: 1s-batched GOOD/UNDEFINED via `MutationObserver`‚Äîlow priority, persists via `isCollapsingEnabled`.
  - *Throttling*: 250ms highlights done, 2s tabs and 1s collapses to come.
  - *Debug*: ‚ÄúManual Check Mode‚Äù with `GM_log`‚Äînot started, planned with persistence.
- *Tests*: Trim 7 redundant skips in `identifyPosts.test.js`, all tests passing in `xGhosted.test.js` (except collapsing).

== How It Works
- *Init*: Sets theme, panel (`createPanel`), `MutationObserver`. Loads persistent state (`isPanelVisible`, `isCollapsingEnabled`, `allPosts`) via `GM_getValue`.
- *Logic*: `xGhosted.js` scans, highlights, updates panel via `identifyPost.js`, `findReplyingToWithDepth.js`; skips processed posts with `processedArticles`. Saves state with `GM_setValue`.
- *State*: Persists visibility, collapsing, theme, links, and post data across sessions.

== Technical Details
- *Files*:
  - `xGhosted.js`: Core, IDs, highlights, delegates to `src/dom/`, persists state.
  - `highlight-potential-problems-template.js`: Userscript shell (0.6.0 panel base).
  - *DOM* (`src/dom/`): `createButton.js`, `createPanel.js` (fixed), `togglePanelVisibility.js`, `renderPanel.js`, `updateTheme.js`, `detectTheme.js`, `loadAllPosts.js`, `saveAllPosts.js`.
  - *Utils*: `identifyPost.js` (lean), `findReplyingToWithDepth.js`, `postQuality.js`, `isProfileRepliesPage.js`, `debounce.js`, `postHasProblemSystemNotice.js`, `postHasProblemCommunity.js`.
- *Styles*: In `src/dom/` and `applyHighlight` (red/yellow/green/none).
- *Depends*: Tampermonkey (`GM_log`, `GM_setValue`, `GM_getValue`), X.com DOM.
- *JSDOM*: `resources: 'usable', runScripts: 'dangerously'` for tests.

== Notes
- Adapt to X.com DOM shifts.
- Resume via link:https://github.com/ajw1970/X-Ghosted[Grok-Prompt.txt], latest commit.
- Large updates may hit attachment errors‚Äînew prompts if so.
- *History*: 0.5.0 had flat state (no persistence, single highlight), evolved to 0.6.0 with structured `state` and richer features (collapsing, multi-color highlights) but weak testing. 0.6.0‚Äôs state handling wins‚Äîbasis for 0.6.1‚Äôs modular, tested `xGhosted.js`, userscript wrapper follows.
- *Lessons Learned March 23, 2025*: 
  - UNDEFINED posts in sample (36 posts: 21 GOOD, 1 PROBLEM, 2 POTENTIAL, 12 UNDEFINED) can lack `<article>`‚Äîtests need conditional logic.
  - Test timing: `highlightPosts()` debounce flakes in Jest; use `highlightPostsImmediate()` for reliability.

== Revision History
- March 16, 2025: Planned 0.6.1.
- March 21, 2025: Streamlined, added throttling/debug.
- March 23, 2025: Noted `identifyPost.js` fix, added persistence details. *Updated with 0.5.0 vs. 0.6.0 analysis‚Äî0.6.0‚Äôs structured state drives 0.6.1‚Äôs modular focus.*
- March 22, 2025: Synced IDs, highlights, DOM extraction, 1 failure status.
- March 23, 2025: Fixed `createPanel.test.js`, flagged 7 redundant tests, integrated `GM_setValue`/`GM_getValue` for state, rules to principles after today‚Äôs flow.
- March 23, 2025: Updated for 0.6.1‚Äî18 tests pass in `xGhosted.test.js`. Beefed up `'highlightPosts applies correct borders'` test‚Äîhandles UNDEFINED posts with/without `<article>`. Next: CSV export (5s throttle). Added lessons: UNDEFINED edge cases, test timing fixes.