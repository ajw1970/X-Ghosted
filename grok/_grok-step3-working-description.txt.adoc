= Grok Step 3: Detailed Description of X-Ghosted Userscript
:author: ajw1970
:date: March 16, 2025
:revdate: March 22, 2025

== Overview
- *Name*: Highlight Potential Problems
- *Purpose*: Flags X.com posts with visual cues and a panel for moderation ease.
- *Version*: Targeting 0.6.1, fixing 0.6.0 rate limits (ref 2ecaf8f49).
- *Target*: `https://x.com/*`, runs at `document-idle`.

== Current State
- *Detection* (`src/utils/identifyPost.js`):
  - *PROBLEM*: System notices or community links.
  - *POTENTIAL PROBLEM*: Replies to problems, depth < 10.
  - *GOOD*: Clean on first scan, unhighlighted.
  - *UNDEFINED*: Filler posts (no articles), assigned IDs like `/prev/status/123#fillerN` based on prior post.
- *UI*: Red (problems), yellow (potential), green (cleared); panel lists flagged posts.
- *Tests*: `identifyPosts.test.js` checks all types with `samples/`.

== End Goal: Version 0.6.1
- *Core*: 
  - `xGhosted.js` powers `highlight-potential-problems.js` (from template), now with deterministic filler IDs (e.g., `/prev/status/123#fillerN`).
- *Features*:
  - *Theme Sync*: Matches X.com‚Äôs light/dim/dark.
  - *Post ID*: Targets `div[data-testid="cellInnerDiv"] > article:not(article article)`.
  - *Visuals*:
    - *PROBLEM*: `2px solid red`, `rgba(255, 0, 0, 0.3)`.
    - *POTENTIAL PROBLEM*: `2px solid yellow`, `rgba(255, 255, 0, 0.3)`.
    - *GOOD*: `2px solid green`, `rgba(0, 255, 0, 0.3)` (post-check).
    - *UNDEFINED*: Collapsible, no highlight.
  - *Panel*: Fixed right-side:
    - Lists PROBLEM/POTENTIAL PROBLEM links (CSV, 5s throttled writes).
    - Toggles: visibility, theme, auto-collapse (Start/Stop/Reset).
    - Buttons: Copy, clear, load links.
  - *Checks*: Eye icon (`üëÄ`) on potential posts; 2s-debounced tab check updates status.
  - *Collapsing*: 1s-batched GOOD/UNDEFINED collapses via `MutationObserver`.
  - *Throttling*: 2s (tabs), 250ms (highlights), 1s (collapses).
  - *Debug*: Optional ‚ÄúManual Check Mode‚Äù with user prompt, logged via `GM_log`.

== How It Works
- *Init*: Sets theme, panel, and `MutationObserver` on posts.
- *Logic*: `xGhosted.js` scans, highlights, and updates panel via `identifyPost.js` and `findReplyingToWithDepth.js`; skips processed posts with a `Map` (`processedArticles`).
- *State*: Persists panel, collapsing, and links across URL shifts.

== Technical Details
- *Files*:
  - `xGhosted.js`: Core logic, now assigns deterministic IDs to UNDEFINED posts.
  - `highlight-potential-problems-template.js`: Userscript shell.
  - Utils: `identifyPost.js` (feeds articles directly), `findReplyingToWithDepth.js` (simplified, no `getArticleElement`), `postQuality.js`, `isProfileRepliesPage.js`, `debounce.js`, `detectTheme.js`.
- *Styles* (`applyHighlight`):
+
[source,javascript]
----
function applyHighlight(article, status = 'potential') {
  const styles = {
    problem: { background: 'rgba(255, 0, 0, 0.3)', border: '2px solid red' },
    potential: { background: 'rgba(255, 255, 0, 0.3)', border: '2px solid yellow' },
    good: { background: 'rgba(0, 255, 0, 0.3)', border: '2px solid green' },
    none: { background: '', border: '' }
  };
  const style = styles[status] || styles.none;
  article.style.backgroundColor = style.background;
  article.style.border = style.border;
}
----
- *Depends*: Tampermonkey (`GM_log`), X.com DOM.
- *JSDOM*: Uses `resources: 'usable', runScripts: 'dangerously'` for reliable DOM parsing in tests.

== Notes
- Adapt to X.com DOM changes.
- Resume via link:https://github.com/ajw1970/X-Ghosted[Grok-Prompt.txt], latest commit.

== Revision History
- March 16, 2025: Detailed 0.6.1 plan.
- March 21, 2025: Streamlined, synced terms (good, not safe), added throttling/debug.
- March 23, 2025: Noted `identifyPost.js` fix‚Äîdropped `getArticleElement` baggage, tests pass clean.
- March 22, 2025: Synced with `identifyPosts()` deterministic IDs‚ÄîUNDEFINED posts now tagged cleanly.