= Grok Session Context: xGhosted Project
:revision-date: April 28, 2025

== Project Overview
- *Product*: Tampermonkey userscript (`src/xGhosted.user.js`) for `x.com`.
- *Purpose*: Identifies and highlights problem posts on x.com, with an optional UI for user interaction.
- *Core Component*: `src/xGhosted.js` (handles x.com DOM interactions, post highlighting, eyeball checks).
- *UI Component*: `PanelManager.js` (manages UI panel, CSV import/export, polling/scrolling controls).
- *Template Component*: `src/xGhosted.template.js` (Tampermonkey interface, logging, storage, config).
- *Dependencies*: Preact, Preact Hooks, Font Awesome (CDN in production, local in dev).
- *Build*: Generated by `build-xGhosted.js` using `esbuild`, outputs `src/xGhosted.user.js`.

== Core Functionality (xGhosted.js)
- *Role*: DOM manipulation and post analysis on x.com.
- *Features*:
  - Classifies posts: Good, Problem, Potential Problem, Undefined, Divider.
  - Highlights posts with color-coded borders.
  - Eyeball check: Opens post in new tab to check for problems, strictly using `[data-xghosted-id="${href}"]` selector (user insists: find exact post or nothing).
- *Timing*:
  - `pollInterval`: 2000ms.
  - `scrollInterval`: 800ms.
  - `highlightPostsDebounced`: 500ms.
  - `checkPostInNewTab`: 250ms interval, 10 attempts (2.5s timeout).
  - `waitForPostRetrieved`: 1000ms timeout.

== UI Functionality (PanelManager.js)
- *Role*: Draggable panel for user interaction.
- *Features*:
  - Displays flagged posts (Problem, Potential Problem).
  - Eyeball click triggers `REQUEST_POST_CHECK`.
  - CSV import/export, polling/scrolling controls, theme switching.
  - Splash screen (`SplashPanel.js`) shown on first load or via "About" button.

== Template Functionality (xGhosted.template.js)
- *Role*: Orchestrates components, handles Tampermonkey specifics.
- *Features*: Initializes `xGhosted.js`, `PanelManager.js`, `MetricsMonitor.js`, `ProcessedPostsManager.js`; manages logging (`GM_log`), storage (`GM_getValue`, `GM_setValue`).

== Recent Changes
- *Timing Data Aggregation (April 28, 2025)*:
  - Updated `MetricsMonitor.js` to aggregate metrics in `xGhosted_timing_history.json`.
  - Replaced arrays (`postsProcessed`, `highlightingDurations`, `sessionDurations`) with:
    - `totalPolls`, `totalSkips`, `totalPostsProcessed`, `avgPostsProcessed`.
    - `totalScrolls`, `bottomReachedCount`.
    - `totalHighlights`, `avgHighlightingDuration`, `maxHighlightingDuration`.
    - `avgSessionDuration`.
  - Capped `metricsHistory` at 100 entries.
  - `xGhosted.js` unchanged, emits raw metrics (e.g., `postsProcessed`, `duration`).

== Current Issues
- *Timing Data Size*: Previously bloated (5+ MB) due to arrays; now aggregated, needs testing.
- *Eyeball Check Sensitivity*: User insists `checkPostInNewTab` in `xGhosted.js` must use only `[data-xghosted-id="${href}"]` selector—no fallbacks.

== Testing Plan
- Run session with polling, auto-scrolling, highlighting.
- Verify `xGhosted_timing_history.json` has aggregated fields, no arrays, capped at 100 entries.
- Export metrics via UI, check JSON format.
- Confirm logs (`logMetrics`) show aggregated values.
- Test eyeball check: Ensure it uses strict selector, logs `Original post found` or `Failed to process`.

== File Inventory
- *Core*: `src/xGhosted.js`, `src/xGhosted.template.js`, `build-xGhosted.js`.
- *UI*: `src/ui/PanelManager.js`, `src/ui/SplashPanel.js`, `src/ui/Panel.jsx`, `src/ui/Modal.css`, `src/ui/Panel.css`.
- *Utils*: `src/utils/MetricsMonitor.js`, `src/utils/ProcessedPostsManager.js`, `src/utils/debounce.js`, `src/utils/findReplyingToWithDepth.js`, `src/utils/getRelativeLinkToPost.js`, `src/utils/identifyPost.js`, `src/utils/isPostDivider.js`, `src/utils/postHasProblemCommunity.js`, `src/utils/postHasProblemSystemNotice.js`, `src/utils/postQuality.js`.
- *DOM*: `src/dom/findPostContainer.js`, `src/dom/parseUrl.js`.
- *Config/Events*: `src/config.js`, `src/events.js`.
- *Dev*: `package.json`, `jest.config.mjs`, `jest.setup.mjs`, `babel.config.mjs`.

== Interaction Guidelines
- *One Step at a Time*: Discuss issues, propose plans, wait for approval before suggesting code edits.
- *Preserve Originals*: Maintain user’s formatting, comments in code unless explicitly told to remove.
- *Clean Code Blocks*: No comments inside code blocks; explanations outside.
- *Blocks First*: Provide full functions or logical chunks, not line-by-line changes.

== Revision History
- April 28, 2025: Aggregated timing data in `MetricsMonitor.js`, capped history at 100 entries.
- April 18, 2025: Decoupled `toggleAutoScrolling` in `Panel.jsx` with `xghosted:set-auto-scrolling` event.