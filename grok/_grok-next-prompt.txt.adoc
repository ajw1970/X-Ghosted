= xGhosted Project Snapshot
:revision-date: April 27, 2025

== Project Overview
- *Product*: Tampermonkey userscript (`src/xGhosted.user.js`) for `x.com`.
- *Purpose*: Identifies and highlights problem posts on x.com, with an optional UI for user interaction.
- *Core Component*: `src/xGhosted.js` (handles x.com DOM interactions).
- *UI Component*: `PanelManager.js` with `Panel.jsx`, `Modal` for CSV import/export, polling, and auto-scrolling controls.
- *Template Component*: `src/xGhosted.template.js` (Tampermonkey interface, logging, storage, configuration).
- *Dependencies*: CDN-hosted Preact, Preact Hooks, Font Awesome in production.
- *Build*: Generated by `build-xGhosted.js` using `esbuild`, outputs `src/xGhosted.user.js`.
- *Version*: 0.6.1 (per `package.json`).

== Core Functionality (xGhosted.js)
- Detects user theme (light, dim, dark).
- Finds post container on x.com.
- Classifies posts as Good, Problem (e.g., deleted), Potential Problem (e.g., suspicious replies), or Undefined.
- Highlights posts with borders (green: good, red: problem, yellow: potential problem, gray: undefined).
- Supports manual thread checks via eyeball icons (in DOM or panel).
- Operates independently of UI (90% functionality without `PanelManager.js`).

== UI Functionality (PanelManager.js)
- Resizable, draggable panel listing problem/potential problem posts.
- Features: Manual thread checks via eyeball icons, CSV import/export, polling/auto-scrolling toggles, splash screen (first load or via "About").
- Eyeball check: Clicking eyeball in panel or DOM opens post in new tab, analyzes, closes tab, updates DOM (if present) and panel (remove good, red dot for problem).
- Requires `xGhosted.js`; optional at runtime (script runs without UI if Preact fails).

== Template Functionality (xGhosted.template.js)
- Initializes `xGhosted.js`, `PanelManager.js`.
- Manages Tampermonkey logging (`GM_log`), storage (`GM_getValue`, `GM_setValue`).
- Passes configuration (e.g., timing) to `xGhosted.js`.

== Eyeball Check Behavior (Desired)
- *Trigger*: Click eyeball icon in panel (e.g., for `/ApostleJohnW/status/1916585400103010426`) or DOM (next to share button).
- *Process*:
  - Open post’s URL (e.g., `https://x.com/ApostleJohnW/status/1916585400103010426`) in *new tab* (not main page).
  - Analyze post in new tab (e.g., using `identifyPost` for notices, communities, replies).
  - Determine quality (`good` or `problem`).
  - Close new tab automatically.
- *Outcome*:
  - If post is in DOM: Update `data-xghosted` (e.g., `postquality.good`), class (e.g., `xghosted-good`), remove eyeball icon.
  - If post is not in DOM: Skip DOM update (not a deal breaker).
  - Always update panel: Remove good posts, mark problems with red dot.
- *Notes*:
  - DOM eyeball clicks ensure post is in DOM at click time.
  - Panel eyeball clicks may reference posts not in DOM (e.g., after navigation).
  - No navigation in main tab (no manual back button needed).
- *Status*: Worked well before recent changes; now broken (opens current tab, no updates).

== Current Issues (Based on console.log.txt, 2025-04-27, 18:02–18:04)
- *Broken Eyeball Check*:
  - Current: Opens post in *current tab* (e.g., 18:03:07.736: “URL has changed ... to .../status/1899820959197995180”), requires manual back button.
  - No DOM updates for missing posts (e.g., 18:03:08.479: “Post ... no longer exists in the DOM, skipping DOM update”).
  - Panel updates inconsistent (e.g., 18:04:28.147: “PanelManager: Processing xghosted:post-registered-confirmed” but no list change).
  - Cause: `checkPostInNewTab` (line 280, `src/xGhosted.js`) uses cached data, doesn’t open new tab; DOM clicks trigger default link navigation.
  - Desired: Restore new tab analysis, DOM/panel updates, no current-tab navigation.
- *Scrolling/Processing When Polling Disabled*:
  - Scrolling occurs when `isPollingEnabled` is false (e.g., 18:04:06.421: “Performing scroll down... Scroll count: 3” while “Recording RECORD_POLL as skipped”).
  - Cause: `startPolling` (line 418) allows `performScroll` if `userRequestedAutoScrolling` is true.
  - Log: “Auto-scrolling and post processing skipped” appears (18:04:24.610), but scrolling still happens.
- *Manual Scrolling Without Warning*:
  - Manual scrolls logged (e.g., 18:03:15.857: “Scroll position changed: 0px to 400px”; 18:04:22.607: “... to 8360px”).
  - No UI warnings despite significant scrolls (> `window.innerHeight`).
  - Cause: `handleStartPolling` (line 333) triggers warnings only on polling re-enable, needs >1 viewport.
- *Timing Metrics (Resolved)*:
  - `xGhosted_timing_history.json` populated (32 entries, 18:04:30.191: “Received xghosted:metrics-retrieved with entries: 32”).
  - Records `polls`, `scrolls`, `highlightingDurations` even when polling disabled (e.g., 18:04:06.421: “Recording RECORD_SCROLL as skipped”).
  - Minor issue: `sessionDurations` empty (`sessionStarts: 0`).

== User Feedback
- Eyeball check was working perfectly before recent changes (new tab, DOM/panel updates, no navigation issues).
- Current eyeball check is broken: opens current tab, no updates, requires back button.
- Preference for one-step-at-a-time fixes with confirmation.
- Frustration with running ahead without confirmation and context limit errors.
- Smooth scrolling (`CONFIG.smoothScrolling: true`) desired; current scrolling failures (e.g., 18:04:06.421: “scrollY unchanged”) need attention.
- Edge console logging preserves logs across URL changes; DOM refreshes may clear logs.

== Current Files
- *Code*: `3-xGhosted.dom.txt` (includes `build-xGhosted.js`, `xGhosted.template.js`, `xGhosted.js`, `ProcessedPostsManager.js`, `TimingManager.js`, utilities).
- *Project Config*: `2-project.stuff.txt` (includes `package.json`, `jest.config.mjs`, `jest.setup.mjs`, `babel.config.mjs`).
- *Metrics*: `xGhosted_timing_history.json` (32 entries, populated).
- *Logs*: `console.log.txt` (2025-04-27, 18:02–18:04, navigation: `ajweltytest/with_replies` → `ajweltytest/status/1899820959197995180` → `apostlejohnw/with_replies`).

== Development Environment
- Tools: Vitest, JSDOM for testing.
- Dependencies: Preact, Preact Hooks (local dev, CDN prod).
- Testing Goal: Unit tests for `xGhosted.js` DOM logic, mock UI interactions.

== Long-Term Goals
- Decouple `xGhosted.js` from Preact UI, use pub/sub interface with `PanelManager.js`.
- Ensure `xGhosted.js` runs standalone, `PanelManager.js` always included in production.
- Progress: `toggleAutoScrolling` decoupled with `xghosted:set-auto-scrolling` event (2025-04-18).

== Revision History
- 2025-04-27: Updated snapshot for fresh conversation, added eyeball check clarification, noted prior working state, included latest logs and metrics.
- 2025-04-27: Initial snapshot created, summarized issues and feedback.
- 2025-04-18: Updated project context with `toggleAutoScrolling` decoupling and splash screen details.
- 2025-04-15: Moved context from `_grok-step1-master-prompt.txt.adoc` to `_grok-step2-project-context.txt.adoc`.

== Notes for Next Session
- Prioritize restoring eyeball check to pre-change state (new tab, DOM/panel updates, no current-tab navigation).
- Confirm each fix step with user before proceeding.
- Address scrolling when polling disabled (e.g., 18:04:06.421).
- Consider manual scrolling warnings and failed scrolls (e.g., 18:04:06.421: “scrollY unchanged”).
- Investigate x.com 403 error (18:02:51.981) if impacting checks.
- Defer refactoring (state splitting, modular `init`, `startPolling`) until fixes validated.
- Avoid context limit errors by keeping responses focused and concise.