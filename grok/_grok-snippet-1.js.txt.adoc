= Snippet 1: createPanel Function (0.6.1 UI Structure)
:revision-date: March 31, 2025

This defines the "Tools" section, modal for import, and overall panel structure with updated CSS for DOM-driven highlighting. Sourced from `src/createPanel.js`.

[source,javascript]
----
function createPanel() {
  GM_log('Creating panel...');
  const mode = detectTheme();
  state.isDarkMode = mode !== 'light';

  try {
    uiElements.panel = document.createElement('div');
    Object.assign(uiElements.panel.style, {
      position: 'fixed',
      top: CONFIG.PANEL.TOP,
      right: CONFIG.PANEL.RIGHT,
      width: CONFIG.PANEL.WIDTH,
      maxHeight: CONFIG.PANEL.MAX_HEIGHT,
      zIndex: CONFIG.PANEL.Z_INDEX,
      background: CONFIG.THEMES[mode].bg,
      color: CONFIG.THEMES[mode].text,
      border: `1px solid ${CONFIG.THEMES[mode].border}`,
      borderRadius: '12px',
      boxShadow: '0 4px 12px rgba(0, 0, 0, 0.15)',
      fontFamily: CONFIG.PANEL.FONT,
      padding: '12px',
      transition: 'all 0.2s ease',
    });

    uiElements.toolbar = document.createElement('div');
    Object.assign(uiElements.toolbar.style, {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      paddingBottom: '12px',
      borderBottom: `1px solid ${CONFIG.THEMES[mode].border}`,
      marginBottom: '12px',
    });

    uiElements.label = document.createElement('span');
    uiElements.label.textContent = 'Posts (0):';
    Object.assign(uiElements.label.style, {
      fontSize: '15px',
      fontWeight: '700',
      color: CONFIG.THEMES[mode].text,
    });

    uiElements.toolsSection = document.createElement('div');
    uiElements.toolsSection.style.display = 'none';
    Object.assign(uiElements.toolsSection.style, {
      padding: '12px 0',
      borderBottom: `1px solid ${CONFIG.THEMES[mode].border}`,
      marginBottom: '12px',
      background: `${CONFIG.THEMES[mode].bg}CC`,
      borderRadius: '8px',
      boxShadow: '0 2px 4px rgba(0, 0, 0, 0.1)',
      transition: 'all 0.3s ease',
    });

    uiElements.toolsToggle = createButton(
      'Tools',
      getSvgIcon('chevron-down'),
      mode,
      () => {
        const isExpanded = uiElements.toolsSection.style.display === 'block';
        uiElements.toolsSection.style.display = isExpanded ? 'none' : 'block';
        uiElements.toolsToggle.querySelector('svg').style.transform =
          isExpanded ? 'rotate(0deg)' : 'rotate(180deg)';
      },
    );
    uiElements.toolsToggle.querySelector('svg').style.transition =
      'transform 0.3s ease';

    const toolsButtonContainer = document.createElement('div');
    Object.assign(toolsButtonContainer.style, {
      display: 'flex',
      justifyContent: 'center',
      gap: '15px',
      padding: '0 10px',
    });

    uiElements.copyButton = createButton(
      'Copy',
      getSvgIcon('copy'),
      mode,
      () => {
        const csvContent = Array.from(state.allPosts)
          .map(([href, status]) => {
            const statusWord =
              status === 'potential_problem'
                ? 'unverified'
                : status === 'problem'
                  ? 'problem'
                  : 'good';
            return `"${statusWord}","https://x.com${href}"`;
          })
          .join('\n');
        const header = '"Status","URL"\n';
        navigator.clipboard
          .writeText(header + csvContent)
          .then(() => {
            GM_log('CSV copied');
            alert('CSV copied to clipboard!');
          })
          .catch((err) => {
            GM_log(`Copy failed: ${err}`);
            alert('Failed to copy CSV.');
          });
      },
    );

    const { modal, textarea } = createModal();
    uiElements.importButton = createButton(
      'Import',
      getSvgIcon('import'),
      mode,
      () => {
        modal.style.display = 'block';
        textarea.focus();
      },
    );

    toolsButtonContainer.append(
      uiElements.copyButton,
      uiElements.importButton,
    );
    uiElements.toolsSection.append(toolsButtonContainer);

    uiElements.modeSelector = document.createElement('select');
    uiElements.modeSelector.innerHTML =
      '<option value="dark">Dark</option><option value="dim">Dim</option><option value="light">Light</option>';
    uiElements.modeSelector.value = mode;
    Object.assign(uiElements.modeSelector.style, {
      background: CONFIG.THEMES[mode].button,
      color: CONFIG.THEMES[mode].text,
      border: 'none',
      padding: '6px 24px 6px 12px',
      borderRadius: '8px',
      cursor: 'pointer',
      fontSize: '12px',
      fontWeight: '500',
      marginRight: '8px',
      minWidth: '80px',
      appearance: 'none',
      outline: 'none',
      boxShadow: '0 2px 4px rgba(0, 0, 0, 0.1)',
    });
    uiElements.modeSelector.addEventListener('change', () => {
      state.isDarkMode = uiElements.modeSelector.value !== 'light';
      updateTheme();
    });

    uiElements.toggleButton = createButton(
      'Hide',
      getSvgIcon('eye'),
      mode,
      togglePanelVisibility,
    );

    uiElements.controlRow = document.createElement('div');
    Object.assign(uiElements.controlRow.style, {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center',
      paddingBottom: '8px',
      marginBottom: '12px',
    });

    uiElements.controlLabel = document.createElement('span');
    uiElements.controlLabel.textContent = 'Auto Collapse Off';
    Object.assign(uiElements.controlLabel.style, {
      fontSize: '13px',
      fontWeight: '500',
      color: CONFIG.THEMES[mode].text,
    });

    const buttonContainer = document.createElement('div');
    Object.assign(buttonContainer.style, { display: 'flex', gap: '8px' });

    buttonContainer.append(
      createButton('Start', getSvgIcon('play'), mode, () => {
        if (state.isRateLimited) {
          GM_log('Collapsing skipped due to rate limit pause');
          return;
        }
        state.isCollapsingEnabled = true;
        state.isCollapsingRunning = true;
        GM_log('Collapsing started');
        updateControlLabel();
        const articles = document.querySelectorAll(
          'div[data-testid="cellInnerDiv"]',
        );
        collapseArticlesWithDelay(articles);
        highlightPotentialProblems();
      }),
      createButton('Stop', getSvgIcon('pause'), mode, () => {
        state.isCollapsingEnabled = false;
        GM_log('Collapsing stopped');
        updateControlLabel();
        highlightPotentialProblems();
      }),
      createButton('Reset', getSvgIcon('reset'), mode, () => {
        state.isCollapsingEnabled = false;
        state.isCollapsingRunning = false;
        GM_log('Collapsing reset');
        document
          .querySelectorAll('div[data-testid="cellInnerDiv"]')
          .forEach(expandArticle);
        state.processedArticles = new WeakSet();
        state.fullyProcessedArticles.clear();
        state.allPosts.clear();
        state.problemLinks.clear();
        if (state.storageAvailable) {
          GM_setValue('allPosts', '{}');
        }
        updateControlLabel();
        highlightPotentialProblems();
      }),
    );

    uiElements.contentWrapper = document.createElement('div');
    uiElements.contentWrapper.className = 'problem-links-wrapper';
    Object.assign(uiElements.contentWrapper.style, {
      maxHeight: 'calc(100vh - 150px)',
      overflowY: 'auto',
      fontSize: '14px',
      lineHeight: '1.4',
      scrollbarWidth: 'thin',
      scrollbarColor: `${CONFIG.THEMES[mode].scroll} ${CONFIG.THEMES[mode].bg}`,
    });

    uiElements.toolbar.append(
      uiElements.label,
      uiElements.toolsToggle,
      uiElements.modeSelector,
      uiElements.toggleButton,
    );
    uiElements.controlRow.append(uiElements.controlLabel, buttonContainer);
    uiElements.panel.append(
      uiElements.toolbar,
      uiElements.toolsSection,
      uiElements.controlRow,
      uiElements.contentWrapper,
    );
    document.body.appendChild(uiElements.panel);
    document.body.appendChild(modal);

    uiElements.styleSheet = document.createElement('style');
    uiElements.styleSheet.textContent = `
      .${CONFIG.HIGHLIGHT_STYLE} { background-color: rgba(255, 255, 0, 0.3); border: 2px solid yellow; }
      .${CONFIG.COLLAPSE_STYLE} { height: 0; overflow: hidden; margin: 0; padding: 0; transition: height 0.2s ease; }
      .xGhosted-problem { border: 2px solid red; }
      .xGhosted-potential_problem { border: 2px solid yellow; background: rgba(255, 255, 0, 0.1); }
      .xGhosted-good { /* Optional: subtle styling if desired */ }
      .xGhosted-undefined { /* No styling needed */ }
      .problem-links-wrapper::-webkit-scrollbar { width: 6px; }
      .problem-links-wrapper::-webkit-scrollbar-thumb { background: ${CONFIG.THEMES[mode].scroll}; border-radius: 3px; }
      .problem-links-wrapper::-webkit-scrollbar-track { background: ${CONFIG.THEMES[mode].bg}; }
      select { background-repeat: no-repeat; background-position: right 8px center; }
      select.dark { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23FFFFFF' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E"); }
      select.dim { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23FFFFFF' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E"); }
      select.light { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23292F33' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E"); }
      select:focus { outline: none; box-shadow: 0 0 0 2px rgba(29, 161, 242, 0.3); }
      .link-item { padding: 4px 0; }
      .status-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; vertical-align: middle; }
      .status-potential { background-color: yellow; }
      .status-problem { background-color: red; }
      .status-safe { background-color: green; }
      .link-row { display: flex; align-items: center; padding: 4px 0; }
      .link-row > div { flex: 1; }
      button span { margin-left: 4px; }
      button svg { width: 12px; height: 12px; }
      .chevron-down { transform: rotate(0deg); }
      .chevron-up { transform: rotate(180deg); }
    `;
    document.head.appendChild(uiElements.styleSheet);
    updateTheme();
    updateControlLabel();
    GM_log('Panel created successfully');
  } catch (e) {
    GM_log(`Error creating panel: ${e.message}`);
  }
}
----